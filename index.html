<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />

  <!-- 이미 로그인된 경우 바로 대시보드로 이동 -->
  <script>
    (function () {
      try {
        const raw = localStorage.getItem("korual_user");
        if (!raw) return;
        const user = JSON.parse(raw);
        if (user && user.username) location.replace("dashboard.html");
      } catch (_) {}
    })();
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KORUAL Control Center – Login</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- KORUAL META (이전 UI 구조 유지) -->
  <script>
    window.KORUAL_META_APP = {
      api: {
        baseUrl: "https://script.google.com/macros/s/AKfycby2FlBu4YXEpeGUAvtXWTbYCi4BNGHNl7GCsaQtsCHuvGXYMELveOkoctEAepFg2F_0/exec",
        secret: "KORUAL-ONLY",
      },
      ui: {
        defaultTheme: "dark",
        defaultLang: "ko",
      },
    };
  </script>

  <style>
    :root { color-scheme: dark; }

    body {
      background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.18), transparent 60%),
                  radial-gradient(circle at 80% 70%, rgba(139,92,246,0.18), transparent 60%),
                  #020617;
      min-height: 100vh;
      color: #e5e7eb;
      font-family: system-ui, Pretendard, sans-serif;
      overflow-x: hidden;
    }

    .radar-ring {
      position: fixed;
      inset: 0;
      margin: auto;
      width: min(640px, 95vw);
      height: min(640px, 95vw);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.18);
      opacity: 0.16;
      pointer-events: none;
      z-index: -1;
    }
    .radar-sweep {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: conic-gradient(
        from 180deg,
        rgba(56,189,248,0.4),
        transparent 40%,
        transparent
      );
      animation: sweep 18s linear infinite;
      filter: blur(6px);
    }
    @keyframes sweep {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 0.9rem;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.55);
      color: #e5e7eb;
      font-size: 0.9rem;
      transition: .2s;
    }
    .input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 4px rgba(56,189,248,0.22);
      outline: none;
    }

    .btn {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 0.9rem;
      font-size: 0.95rem;
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      transition: .2s;
      box-shadow: 0 18px 48px rgba(15,23,42,0.95);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 26px 60px rgba(15,23,42,1);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    .glass {
      background: rgba(15,23,42,0.85);
      backdrop-filter: blur(24px);
      border: 1px solid rgba(148,163,184,0.2);
    }

    /* Toast */
    .toast {
      pointer-events: auto;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.72);
      backdrop-filter: blur(18px);
    }
  </style>
</head>

<body>
  <div class="radar-ring">
    <div class="radar-sweep"></div>
  </div>

  <!-- Toast root -->
  <div id="toastRoot" class="fixed inset-x-0 bottom-6 z-40 flex justify-center pointer-events-none"></div>

  <!-- MAIN LOGIN CARD -->
  <main class="max-w-5xl mx-auto px-6 pt-16">
    <div class="text-center mb-10">
      <div class="inline-flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-white grid place-content-center text-slate-900 font-bold text-xl shadow-lg">K</div>
        <div class="text-left">
          <p class="text-[11px] uppercase tracking-[0.3em] text-slate-400">Korual Control Center</p>
          <h1 class="text-2xl font-semibold">24h 자동화 커머스 레이더</h1>
        </div>
      </div>
    </div>

    <section class="glass rounded-3xl max-w-xl mx-auto px-6 py-7 shadow-[0_32px_90px_rgba(15,23,42,0.98)]">
      <h2 class="text-xl font-semibold mb-6">KORUAL 로그인</h2>

      <div class="space-y-4">
        <div>
          <label class="text-sm mb-1 block">아이디</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">@</span>
            <input id="loginUsername" class="input pl-8" placeholder="예: KORUAL" />
          </div>
        </div>

        <div>
          <label class="text-sm mb-1 block">비밀번호</label>
          <input id="loginPassword" type="password" class="input" placeholder="••••••••" />
        </div>

        <button id="btnLogin" class="btn mt-2">로그인</button>

        <p id="loginMsg" class="text-sm text-rose-400 h-4 mt-1"></p>
      </div>

      <!-- 샘플 계정 -->
      <div class="mt-6 text-xs text-slate-400">
        <p class="font-medium text-slate-300">테스트용 기본 계정</p>
        <div class="inline-flex gap-2 items-center bg-slate-900/80 px-3 py-2 mt-2 rounded-xl border border-slate-700/70">
          <span>ID:</span><code class="bg-slate-800 px-1.5 py-0.5 rounded">KORUAL</code>
          <span>/ PW:</span><code class="bg-slate-800 px-1.5 py-0.5 rounded">GUEST</code>
          <button
            id="btnFillDemo"
            class="underline decoration-dotted ml-2 text-sky-300"
            type="button"
          >
            자동 입력
          </button>
        </div>
      </div>
    </section>
  </main>

  <script>
    /************************************************************
     * Login client (index.html 단독)
     * - GAS WebApp: ?action=login (POST JSON)
     * - 성공 시:
     *   localStorage.korual_token 저장
     *   localStorage.korual_user 저장
     *   dashboard.html로 이동
     ************************************************************/

    const API_BASE = (window.KORUAL_META_APP && window.KORUAL_META_APP.api && window.KORUAL_META_APP.api.baseUrl)
      ? window.KORUAL_META_APP.api.baseUrl
      : "https://script.google.com/macros/s/AKfycby2FlBu4YXEpeGUAvtXWTbYCi4BNGHNl7GCsaQtsCHuvGXYMELveOkoctEAepFg2F_0/exec";

    const TOKEN_KEY = "korual_token";
    const USER_KEY  = "korual_user";

    const elU = document.getElementById("loginUsername");
    const elP = document.getElementById("loginPassword");
    const elBtn = document.getElementById("btnLogin");
    const elMsg = document.getElementById("loginMsg");
    const elDemo = document.getElementById("btnFillDemo");
    const toastRoot = document.getElementById("toastRoot");

    function setMsg(text){
      elMsg.textContent = text || "";
    }

    function setLoading(loading){
      elBtn.disabled = !!loading;
      elBtn.textContent = loading ? "로그인 중..." : "로그인";
    }

    function toast(text, kind){
      const wrap = document.createElement("div");
      wrap.className = "toast pointer-events-auto max-w-[520px] w-[92%] px-4 py-3 rounded-2xl shadow-[0_22px_70px_rgba(0,0,0,.55)]";
      wrap.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="mt-0.5 w-2.5 h-2.5 rounded-full ${kind === "ok" ? "bg-emerald-400" : kind === "warn" ? "bg-amber-400" : "bg-rose-400"}"></div>
          <div class="text-sm text-slate-100 whitespace-pre-line">${escapeHtml(text)}</div>
        </div>
      `;
      toastRoot.appendChild(wrap);

      setTimeout(() => {
        wrap.style.opacity = "0";
        wrap.style.transform = "translateY(6px)";
        wrap.style.transition = "all .35s ease";
      }, 2400);
      setTimeout(() => wrap.remove(), 2900);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    async function postJson(url, body, headers){
      const res = await fetch(url, {
        method: "POST",
        headers: Object.assign({ "Content-Type": "application/json" }, headers || {}),
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    async function login(username, password){
      // 기존 Code.gs 스타일: action=login + JSON body
      const url = `${API_BASE}?action=login`;
      return postJson(url, { username, password });
    }

    function saveSession(result){
      // result: { token, user, ... }
      if (result && result.token) localStorage.setItem(TOKEN_KEY, result.token);
      if (result && result.user)  localStorage.setItem(USER_KEY, JSON.stringify(result.user));
    }

    function normalizeErrorPayload(data){
      const err = (data && data.error) ? String(data.error) : "LOGIN_FAILED";
      let extra = "";

      if (err === "ACCOUNT_LOCKED" && data.lockedUntil) extra = `\n잠금 해제: ${data.lockedUntil}`;
      if (err === "INVALID_PASSWORD" && typeof data.failCount === "number") extra = `\n실패 횟수: ${data.failCount}`;
      return { err, extra };
    }

    async function handleLogin(){
      setMsg("");
      const username = String(elU.value || "").trim();
      const password = String(elP.value || "");

      if (!username || !password){
        setMsg("아이디/비밀번호를 입력하세요.");
        return;
      }

      setLoading(true);
      try{
        const { data } = await login(username, password);

        // Apps Script는 status code 제약이 있으므로 ok 플래그를 최우선
        if (!data || !data.ok){
          const { err, extra } = normalizeErrorPayload(data || {});
          setMsg(`로그인 실패: ${err}`);
          toast(`로그인 실패: ${err}${extra}`, "err");
          return;
        }

        saveSession(data);
        const display = (data.user && (data.user.displayName || data.user.username)) || username;

        toast(`로그인 성공\nWelcome, ${display}`, "ok");
        location.replace("dashboard.html");
      } catch (e){
        setMsg("서버 통신 실패");
        toast("서버 통신 실패\n" + String(e), "err");
      } finally{
        setLoading(false);
      }
    }

    elBtn.addEventListener("click", handleLogin);

    // Enter 키로 로그인
    [elU, elP].forEach(el => {
      el.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          handleLogin();
        }
      });
    });

    // 데모 자동 입력
    elDemo.addEventListener("click", () => {
      elU.value = "KORUAL";
      elP.value = "GUEST";
      setMsg("");
      toast("데모 계정 자동 입력 완료", "warn");
      elP.focus();
    });
  </script>
</body>
</html>
