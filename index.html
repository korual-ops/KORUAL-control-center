<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Korual â€” Web</title>
<link rel="icon" href="data:," />
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js + Luxon time adapter for time scales -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
<style>
  :root{color-scheme:light dark}
  .glass{backdrop-filter: blur(18px)}
  .card{ @apply bg-white/80 dark:bg-slate-900/80 glass rounded-2xl shadow-xl p-6 md:p-7 border border-slate-100/60 dark:border-slate-800; }
  .btn{ @apply inline-flex items-center justify-center px-4 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-medium tracking-tight hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition; }
  .btn-alt{ @apply inline-flex items-center justify-center px-3.5 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700/80 text-sm hover:bg-slate-100/70 dark:hover:bg-slate-800/70 transition; }
  .input{ @apply w-full px-3.5 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/80 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500/70 focus:border-blue-500/70; }
  .pill{ @apply px-3 py-1.5 rounded-full text-xs bg-slate-900/5 dark:bg-white/5 border border-slate-200/60 dark:border-slate-700/70; }
  .tab{ @apply px-3 py-2 rounded-xl cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-medium transition; }
  .tab.active{ @apply bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-sm; }
  .auth-hero{background: radial-gradient(1200px 800px at 0% 0%, rgba(59,130,246,.23), transparent 60%), radial-gradient(900px 700px at 100% 100%, rgba(168,85,247,.25), transparent 60%);} 
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100">
<div class="max-w-6xl mx-auto p-4 md:p-8">
  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-3 mb-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-blue-600 text-white grid place-content-center text-xl font-bold">K</div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold leading-tight">Korual</h1>
        <p class="text-sm text-slate-500 -mt-1">Lightweight community & tools</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input id="searchPosts" class="input w-44" placeholder="ê²€ìƒ‰ / Search" />
      <select id="langSelect" class="input w-28">
        <option value="ko">í•œêµ­ì–´</option>
        <option value="en">English</option>
      </select>
      <button id="toggleTheme" class="btn-alt" title="Theme">ğŸŒ“</button>
      <button id="btnExport" class="btn-alt" title="Export JSON">Export</button>
      <label class="btn-alt cursor-pointer" title="Import JSON">
        <input id="fileImport" type="file" accept="application/json" class="hidden"/>Import
      </label>
      <button id="runTests" class="btn-alt">Run Tests</button>
    </div>
  </header>

  <!-- AUTH -->
  <section id="authView" class="auth-hero min-h-[80vh] flex items-center justify-center mb-8">
  <div class="w-full max-w-5xl grid md:grid-cols-[1.05fr,1.25fr] gap-0 rounded-3xl overflow-hidden shadow-2xl bg-slate-950/80 text-slate-50 border border-slate-800">
    <!-- Brand / Preview side -->
    <div class="relative hidden md:flex flex-col justify-between p-7 lg:p-8 bg-gradient-to-br from-slate-900 via-slate-950 to-slate-950">
      <div class="space-y-6">
        <div class="inline-flex items-center gap-3 rounded-2xl bg-white/5 px-3 py-2 border border-white/10">
          <div class="w-10 h-10 rounded-2xl bg-white text-slate-900 grid place-content-center text-xl font-bold">K</div>
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Korual Control Center</p>
            <p class="text-sm text-slate-200">24h ìë™í™” ì»¤ë¨¸ìŠ¤ ë ˆì´ë”</p>
          </div>
        </div>
        <div class="space-y-3">
          <h2 class="text-2xl lg:text-3xl font-semibold leading-snug">í•œ í™”ë©´ì—ì„œ ë³´ëŠ” <span class="text-blue-400">KORUAL</span> ê´€ì œíƒ‘</h2>
          <p class="text-sm text-slate-300/90">ë¡œê·¸ì¸í•˜ë©´ ì‹¤ì‹œê°„ ì£¼ë¬¸, íšŒì›, ìë™í™” ìƒíƒœë¥¼ ê¸°ì¡´ ë°±ì—”ë“œ í™”ë©´ì—ì„œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="grid gap-2 text-xs text-slate-300/90">
          <div class="flex items-center gap-2"><span class="text-blue-400 text-lg">â–Œ</span><span>ë¸Œë¼ìš°ì € LocalStorage ê¸°ë°˜ â€“ ì´ ê¸°ê¸°ì—ì„œë§Œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥</span></div>
          <div class="flex items-center gap-2"><span class="text-emerald-400 text-lg">â–Œ</span><span>ì¶”í›„ KORUAL API ì—°ë™ ì‹œ, ì‹¤ì œ ì£¼ë¬¸/ë§¤ì¶œ ë°ì´í„° ëŒ€ì‹œë³´ë“œë¡œ í™•ì¥ ê°€ëŠ¥</span></div>
          <div class="flex items-center gap-2"><span class="text-violet-400 text-lg">â–Œ</span><span>Export / Import ë¡œ ì„¤ì •ê°’ ë°±ì—… í›„, GitHub Â· Vercelì— ë°”ë¡œ ë°°í¬</span></div>
        </div>
      </div>
      <div class="mt-6 space-y-3 text-[11px] text-slate-400">
        <p class="font-medium text-slate-300">í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ ê³„ì •</p>
        <div class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-900/60 border border-slate-700/80">
          <span class="text-slate-400">ID</span>
          <code class="px-1.5 py-0.5 rounded-md bg-slate-800 text-slate-100 text-[11px]">KORUAL</code>
          <span class="text-slate-600">/</span>
          <span class="text-slate-400">PW</span>
          <code class="px-1.5 py-0.5 rounded-md bg-slate-800 text-slate-100 text-[11px]">korual1228!</code>
        </div>
        <p>ë¡œê·¸ì¸ í›„ì—ëŠ” ìë™ìœ¼ë¡œ <span class="text-sky-300">dashboard.html</span> ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- Auth side -->
    <div class="bg-slate-900/80 backdrop-blur px-6 py-7 lg:px-8 lg:py-8">
      <div class="flex items-center justify-between mb-6">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.22em] text-slate-400">Sign in to Korual</p>
          <h1 class="text-xl font-semibold">KORUAL ê³„ì •ìœ¼ë¡œ ì ‘ì†</h1>
        </div>
        <div class="flex items-center gap-2">
          <select id="langSelect" class="input w-28 text-xs bg-slate-900/80 border-slate-700/80">
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
          </select>
          <button id="toggleTheme" class="btn-alt text-lg" title="Theme">ğŸŒ“</button>
        </div>
      </div>

      <div class="grid gap-6">
        <!-- Login card -->
        <div class="space-y-4 rounded-2xl border border-slate-700/80 bg-slate-900/70 px-5 py-5">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-base font-semibold" data-i18n="login">ë¡œê·¸ì¸</h2>
            <span class="pill text-[11px] text-slate-400">Control Center ì…ì¥</span>
          </div>
          <div class="space-y-3.5">
            <div>
              <label class="block mb-1.5 text-sm" data-i18n="username">ì•„ì´ë””</label>
              <input id="loginUsername" class="input bg-slate-950/60 border-slate-700/70" placeholder="ì˜ˆ: KORUAL" autocomplete="username" />
            </div>
            <div>
              <label class="block mb-1.5 text-sm" data-i18n="password">ë¹„ë°€ë²ˆí˜¸</label>
              <input id="loginPassword" class="input bg-slate-950/60 border-slate-700/70" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
            </div>
            <div class="flex flex-wrap items-center gap-2 justify-between">
              <button id="btnLogin" class="btn min-w-[120px]" data-i18n="login">ë¡œê·¸ì¸</button>
              <p class="text-xs text-slate-400">ì—”í„°í‚¤ë¡œë„ ë¡œê·¸ì¸ ê°€ëŠ¥</p>
            </div>
            <p id="loginMsg" class="text-xs text-rose-400 min-h-[1rem]"></p>
          </div>
        </div>

        <!-- Signup card -->
        <div class="space-y-4 rounded-2xl border border-slate-700/70 bg-slate-900/60 px-5 py-5">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-base font-semibold" data-i18n="signup">íšŒì›ê°€ì…</h2>
            <span class="pill text-[11px] text-slate-400">ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ê³„ì • ìƒì„±</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block mb-1 text-sm" data-i18n="full_name">ì´ë¦„</label>
              <input id="suName" class="input bg-slate-950/60 border-slate-700/70" placeholder="í™ê¸¸ë™" />
            </div>
            <div>
              <label class="block mb-1 text-sm" data-i18n="email">ì´ë©”ì¼</label>
              <input id="suEmail" class="input bg-slate-950/60 border-slate-700/70" placeholder="you@korual.app" />
            </div>
            <div>
              <label class="block mb-1 text-sm" data-i18n="username">ì•„ì´ë””</label>
              <input id="suUser" class="input bg-slate-950/60 border-slate-700/70" placeholder="ì˜ë¬¸/ìˆ«ì ì¡°í•©" autocomplete="username" />
            </div>
            <div>
              <label class="block mb-1 text-sm" data-i18n="password">ë¹„ë°€ë²ˆí˜¸</label>
              <input id="suPass" class="input bg-slate-950/60 border-slate-700/70" type="password" placeholder="ìµœì†Œ 6ìë¦¬" autocomplete="new-password" />
            </div>
          </div>
          <div class="flex items-center gap-2 mt-1">
            <button id="btnSignup" class="btn" data-i18n="signup">íšŒì›ê°€ì…</button>
            <span id="signupMsg" class="text-xs text-slate-300"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- APP -->
  <section id="appView" class="hidden">
    <div class="card mb-4 flex items-center justify-between">
      <div>
        <div id="welcome" class="text-lg font-semibold"></div>
        <div id="userInfo" class="text-sm text-slate-500"></div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLogout" class="btn-alt" data-i18n="logout">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <nav id="tabs" class="flex flex-wrap gap-2 mb-4">
      <button class="tab active" data-tab="dashboard" data-i18n="dashboard">ëŒ€ì‹œë³´ë“œ</button>
      <button class="tab" data-tab="fx" data-i18n="fx">í™˜ìœ¨</button>
      <button class="tab" data-tab="stocks" data-i18n="stocks">ì£¼ì‹</button>
      <button class="tab" data-tab="community" data-i18n="community">ì»¤ë®¤ë‹ˆí‹°</button>
      <button id="adminTab" class="tab" data-tab="admin" data-i18n="admin">ê´€ë¦¬ì</button>
    </nav>

    <!-- Dashboard -->
    <div id="tab-dashboard" class="card">
      <h3 class="text-xl font-semibold mb-2" data-i18n="dashboard">ëŒ€ì‹œë³´ë“œ</h3>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/30">
          <div class="font-semibold mb-1">Tips</div>
          <ul class="text-sm text-slate-600 dark:text-slate-300 list-disc pl-5">
            <li>LocalStorage ê¸°ë°˜ â€” ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</li>
            <li>Export/Import ë²„íŠ¼ìœ¼ë¡œ ë°±ì—…/ë³µì› ê°€ëŠ¥.</li>
            <li>ë‹¨ì¶•í‚¤: <span class="pill">/</span> ê²€ìƒ‰, <span class="pill">L</span> ë¡œê·¸ì¸, <span class="pill">N</span> ìƒˆ ê¸€.</li>
          </ul>
        </div>
        <div class="p-4 rounded-2xl bg-emerald-50 dark:bg-emerald-900/30">
          <div class="font-semibold mb-1">Modules</div>
          <p class="text-sm">FX, Stock, Community, Admin</p>
        </div>
        <div class="p-4 rounded-2xl bg-violet-50 dark:bg-violet-900/30">
          <div class="font-semibold mb-1">Theme</div>
          <p class="text-sm">ë¼ì´íŠ¸/ë‹¤í¬/ìë™ ì „í™˜ ì§€ì›</p>
        </div>
      </div>
    </div>

    <!-- FX -->
    <div id="tab-fx" class="card hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold" data-i18n="fx">í™˜ìœ¨</h3>
        <span id="fxCacheMsg" class="text-xs text-slate-500"></span>
      </div>
      <div class="flex flex-wrap items-end gap-3">
        <div><label class="block mb-1" data-i18n="base_currency">ê¸°ì¤€í†µí™”(ì˜ˆ: USD)</label><input id="fxBase" class="input w-28" value="USD"/></div>
        <div><label class="block mb-1" data-i18n="target_currency">ëŒ€ìƒí†µí™”(ì˜ˆ: KRW)</label><input id="fxTarget" class="input w-28" value="KRW"/></div>
        <button id="btnRate" class="btn" data-i18n="get_rate">í™˜ìœ¨ ì¡°íšŒ</button>
        <span id="fxResult" class="text-lg font-semibold"></span>
      </div>
    </div>

    <!-- Stocks -->
    <div id="tab-stocks" class="card hidden">
      <h3 class="text-xl font-semibold mb-3" data-i18n="stocks">ì£¼ì‹</h3>
      <div class="flex flex-wrap items-end gap-3 mb-3">
        <div><label class="block mb-1" data-i18n="ticker">í‹°ì»¤(ì˜ˆ: AAPL)</label><input id="stockTicker" class="input w-32" value="AAPL"/></div>
        <button id="btnDraw" class="btn" data-i18n="draw_chart">ì°¨íŠ¸ ê·¸ë¦¬ê¸°</button>
        <span id="stockMsg" class="text-sm text-slate-500"></span>
      </div>
      <canvas id="stockCanvas" height="120" aria-label="Stock chart"></canvas>
    </div>

    <!-- Community -->
    <div id="tab-community" class="card hidden">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold" data-i18n="title_posts">ê²Œì‹œê¸€</h3>
            <button id="btnNewPost" class="btn-alt" data-i18n="new_post">ìƒˆ ê¸€</button>
          </div>
          <ul id="postList" class="space-y-2"></ul>
          <div class="text-xs text-slate-500 mt-2" id="postCount"></div>
        </div>
        <div class="md:col-span-2">
          <div class="grid gap-2">
            <input id="postTitle" class="input" placeholder="ì œëª©" />
            <textarea id="postContent" class="input h-32" placeholder="ë‚´ìš©"></textarea>
            <div class="flex flex-wrap items-center gap-2 justify-end">
              <span id="autoSaveMsg" class="text-xs text-slate-500 mr-auto"></span>
              <button id="btnSavePost" class="btn" data-i18n="save">ì €ì¥</button>
              <button id="btnDeletePost" class="btn-alt" data-i18n="delete_post">ì‚­ì œ</button>
            </div>
          </div>
          <div class="mt-6">
            <h4 class="font-semibold mb-2" data-i18n="comment">ëŒ“ê¸€</h4>
            <ul id="commentList" class="space-y-2 mb-2"></ul>
            <div class="flex gap-2">
              <input id="commentInput" class="input flex-1" placeholder="ëŒ“ê¸€" />
              <button id="btnAddComment" class="btn" data-i18n="add_comment">ëŒ“ê¸€ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="tab-admin" class="card hidden">
      <h3 class="text-xl font-semibold mb-3" data-i18n="admin_panel">ê´€ë¦¬ì íŒ¨ë„</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="font-semibold mb-1" data-i18n="users">ì‚¬ìš©ì</h4>
          <div id="userTable" class="overflow-auto border rounded-xl"></div>
        </div>
        <div>
          <h4 class="font-semibold mb-1" data-i18n="logs">ë¡œê·¸</h4>
          <div id="logTable" class="overflow-auto border rounded-xl"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<template id="tableTpl"><table class="min-w-full text-sm"><thead></thead><tbody></tbody></table></template>
<script>
/***** i18n *****/
const I18N={
  ko:{login:"ë¡œê·¸ì¸",signup:"íšŒì›ê°€ì…",logout:"ë¡œê·¸ì•„ì›ƒ",username:"ì•„ì´ë””",password:"ë¹„ë°€ë²ˆí˜¸",full_name:"ì´ë¦„",email:"ì´ë©”ì¼",dashboard:"ëŒ€ì‹œë³´ë“œ",fx:"í™˜ìœ¨",stocks:"ì£¼ì‹",community:"ì»¤ë®¤ë‹ˆí‹°",admin:"ê´€ë¦¬ì",base_currency:"ê¸°ì¤€í†µí™”(ì˜ˆ: USD)",target_currency:"ëŒ€ìƒí†µí™”(ì˜ˆ: KRW)",get_rate:"í™˜ìœ¨ ì¡°íšŒ",ticker:"í‹°ì»¤(ì˜ˆ: AAPL)",draw_chart:"ì°¨íŠ¸ ê·¸ë¦¬ê¸°",title_posts:"ê²Œì‹œê¸€",new_post:"ìƒˆ ê¸€",save:"ì €ì¥",delete_post:"ì‚­ì œ",comment:"ëŒ“ê¸€",add_comment:"ëŒ“ê¸€ ì¶”ê°€",login_failed:"ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.",signup_done:"íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.",user_exists:"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.",need_title:"ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.",need_content:"ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.",not_owner:"ë³¸ì¸ ì†Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.",admin_panel:"ê´€ë¦¬ì íŒ¨ë„",users:"ì‚¬ìš©ì",logs:"ë¡œê·¸",welcome:n=>`í™˜ì˜í•©ë‹ˆë‹¤, ${n}ë‹˜`,rate_result:(b,r,t)=>`1 ${b} = ${(+r).toFixed(4)} ${t}`},
  en:{login:"Login",signup:"Sign Up",logout:"Logout",username:"Username",password:"Password",full_name:"Full Name",email:"Email",dashboard:"Dashboard",fx:"FX",stocks:"Stocks",community:"Community",admin:"Admin",base_currency:"Base (e.g., USD)",target_currency:"Target (e.g., KRW)",get_rate:"Get Rate",ticker:"Ticker (e.g., AAPL)",draw_chart:"Draw Chart",title_posts:"Posts",new_post:"New",save:"Save",delete_post:"Delete",comment:"Comment",add_comment:"Add Comment",login_failed:"Login failed: check username/password.",signup_done:"Sign-up completed! Please login.",user_exists:"Username already exists.",need_title:"Please enter a title.",need_content:"Please enter content.",not_owner:"You are not the owner.",admin_panel:"Admin Panel",users:"Users",logs:"Logs",welcome:n=>`Welcome, ${n}`,rate_result:(b,r,t)=>`1 ${b} = ${(+r).toFixed(4)} ${t}`}
};
let LANG=localStorage.getItem('korual_lang')||'ko';
function applyI18n(){document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.dataset.i18n,v=I18N[LANG][k]; if(typeof v!=='function'&&v) el.textContent=v;}); document.getElementById('langSelect').value=LANG;}

/***** Storage *****/
const LS={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const KEY={users:'korual_users',posts:'korual_posts',comments:'korual_comments',logs:'korual_logs',draft:'korual_draft',theme:'korual_theme'};

/***** Crypto (SHA-256) *****/
async function sha256Hex(s){const enc=new TextEncoder();const buf=await crypto.subtle.digest('SHA-256',enc.encode(s));return[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('')}
async function hashPw(password,salt){salt=salt||[...crypto.getRandomValues(new Uint8Array(16))].map(b=>b.toString(16).padStart(2,'0')).join('');return{salt,digest:await sha256Hex(salt+password)}}

/***** Seed admin *****/
async function ensureAdmin(){const users=LS.get(KEY.users,[]); if(!users.find(u=>u.username==='KORUAL')){const {digest,salt}=await hashPw('korual1228!'); users.push({id:1,username:'KORUAL',full_name:'Administrator',email:'admin@korual.local',is_admin:true,pw_hash:digest,pw_salt:salt,created_at:new Date().toISOString()}); LS.set(KEY.users,users)}}

/***** Auth & Logs *****/
let CUR=null; function log(action,meta){const L=LS.get(KEY.logs,[]); L.unshift({id:Date.now(),user:CUR?.username||null,action,at:new Date().toISOString(),meta}); LS.set(KEY.logs,L)}
async function loginUser(u,p){const U=LS.get(KEY.users,[]); const x=U.find(v=>v.username===u); if(!x) return false; const {digest}=await hashPw(p,x.pw_salt); if(digest!==x.pw_hash) return false; CUR=x; log('login',{ua:navigator.userAgent}); return true}
async function signupUser({username,password,full_name,email}){const U=LS.get(KEY.users,[]); if(U.find(v=>v.username===username)) throw new Error('exists'); const {digest,salt}=await hashPw(password); const id=U.length?Math.max(...U.map(u=>u.id||0))+1:1; U.push({id,username,full_name,email,is_admin:false,pw_hash:digest,pw_salt:salt,created_at:new Date().toISOString()}); LS.set(KEY.users,U);}

/***** Bad words *****/
const BAD=['ì‹œë°œ','ì”¨ë°œ','ë³‘ì‹ ','fuck','shit']; const hasBad=t=>BAD.some(b=>(t||'').toLowerCase().includes(b.toLowerCase()));

/***** Community *****/
const listPosts=()=>LS.get(KEY.posts,[]);
function savePost(p){const P=listPosts(); if(!p.id){p.id=Date.now(); P.unshift(p)} else {const i=P.findIndex(x=>x.id===p.id); if(i>=0) P[i]=p; else P.unshift(p)} LS.set(KEY.posts,P)}
function deletePost(id){LS.set(KEY.posts,listPosts().filter(p=>p.id!==id)); LS.set(KEY.comments,LS.get(KEY.comments,[]).filter(c=>c.post_id!==id))}
const listComments=pid=>LS.get(KEY.comments,[]).filter(c=>c.post_id===pid);
function addComment(pid,content){const C=LS.get(KEY.comments,[]); C.push({id:Date.now(),post_id:pid,user:CUR.username,content,at:new Date().toISOString()}); LS.set(KEY.comments,C)}
function deleteComment(id){LS.set(KEY.comments,LS.get(KEY.comments,[]).filter(c=>c.id!==id))}

/***** Helpers *****/
function $(id){return document.getElementById(id)}
function show(e){e.classList.remove('hidden')} function hide(e){e.classList.add('hidden')}
function setTab(name){document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.toggle('active',b.dataset.tab===name)); ['dashboard','fx','stocks','community','admin'].forEach(t=>{(t===name?show:hide)($("tab-"+t))})}
function table(headers,rows){const tpl=document.getElementById('tableTpl'); const frag=tpl.content.cloneNode(true); frag.querySelector('thead').innerHTML=`<tr>${headers.map(h=>`<th class='text-left px-3 py-2 border-b'>${h}</th>`).join('')}</tr>`; frag.querySelector('tbody').innerHTML=rows.map(r=>`<tr>${r.map(c=>`<td class='px-3 py-2 border-b align-top whitespace-pre-wrap'>${c}</td>`).join('')}</tr>`).join(''); return frag}

/***** FX (6h cache) *****/
function rateCacheKey(b,t){return `korual_fx_${b}_${t}`}
async function getRate(base,target){const k=rateCacheKey(base,target); const cached=LS.get(k,null); if(cached && (Date.now()-cached.ts<6*60*60*1000)){ $('fxCacheMsg').textContent=`cached ${new Date(cached.ts).toLocaleString()}`; return cached.rate } $('fxCacheMsg').textContent=''; const url=`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(target)}`; const r=await fetch(url); const j=await r.json(); const rate=j.rates?.[target]; if(rate){LS.set(k,{rate,ts:Date.now()})} return rate }

/***** Stocks *****/
async function yahooDaily(t){const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(t)}?range=6mo&interval=1d`; const r=await fetch(url); if(!r.ok) throw new Error('fetch'); const j=await r.json(); const res=j.chart?.result?.[0]; if(!res) throw new Error('nores'); const ts=res.timestamp||[]; const close=res.indicators?.quote?.[0]?.close||[]; return ts.map((t,i)=>({x:new Date(t*1000),y:close[i]})).filter(p=>Number.isFinite(p.y)) }
let chart; function draw(points){const ctx=$('stockCanvas'); if(chart) chart.destroy(); chart=new Chart(ctx,{type:'line',data:{datasets:[{label:'Close (6M)',data:points,parsing:false,borderWidth:2,tension:.15}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{x:{type:'time',time:{unit:'month'}},y:{beginAtZero:false}}}})}

/***** Tests *****/
async function runTests(){const out=[]; const ok=(n,c)=>{out.push(`${c?'âœ…':'âŒ'} ${n}`); if(!c) throw new Error(n)}; const a1=await hashPw('pw','abc'); const a2=await hashPw('pw','abc'); ok('hash determinism',a1.digest===a2.digest); await ensureAdmin(); ok('admin exists',!!LS.get(KEY.users,[]).find(u=>u.username==='KORUAL')); ok('bad-true',hasBad('ì”¨ë°œ ë“¤ì–´ê°')); ok('bad-false',!hasBad('ê¹¨ë—')); await signupUser({username:'__t__',password:'x',full_name:'T',email:'t@x'}); ok('signup user',!!LS.get(KEY.users,[]).find(u=>u.username==='__t__')); ok('login',await loginUser('__t__','x')); $('loginMsg').textContent='Tests OK'; alert('All tests passed!'); console.log(out.join('\n')) }

/***** Bootstrap *****/
(async function(){
  // theme
  const theme=LS.get(KEY.theme,'auto'); applyTheme(theme); $('toggleTheme').addEventListener('click',()=>{const next={'auto':'light','light':'dark','dark':'auto'}[LS.get(KEY.theme,'auto')]||'auto'; LS.set(KEY.theme,next); applyTheme(next)}); function applyTheme(mode){document.documentElement.dataset.theme=mode; const mql=window.matchMedia('(prefers-color-scheme: dark)'); document.documentElement.classList.toggle('dark',mode==='dark'||(mode==='auto'&&mql.matches))}

  await ensureAdmin();
  applyI18n();

  // language
  $('langSelect').addEventListener('change',e=>{LANG=e.target.value; localStorage.setItem('korual_lang',LANG); applyI18n(); if(CUR){$('welcome').textContent=I18N[LANG].welcome(CUR.full_name||CUR.username)}});

  // tests
  $('runTests').addEventListener('click',runTests);

  // auth
// auth
$('btnSignup').addEventListener('click', async () => {
  const payload = {
    full_name: $('suName').value.trim(),
    email: $('suEmail').value.trim(),
    username: $('suUser').value.trim(),
    password: $('suPass').value
  };
  if (!payload.username || !payload.password) {
    $('signupMsg').textContent = 'Username & password required.';
    return;
  }
  try {
    await signupUser(payload);
    $('signupMsg').textContent = I18N[LANG].signup_done;
  } catch {
    $('signupMsg').textContent = I18N[LANG].user_exists;
  }
});

$('btnLogin').addEventListener('click', async () => {
  const ok = await loginUser(
    $('loginUsername').value.trim(),
    $('loginPassword').value
  );
  if (!ok) {
    $('loginMsg').textContent = I18N[LANG].login_failed;
    return;
  }
  // âœ… ë¡œê·¸ì¸ ì„±ê³µ â†’ dashboard.html ë¡œ ì´ë™
  window.location.href = "dashboard.html";
});
// Enter í‚¤ë¡œ ë¡œê·¸ì¸
['loginUsername', 'loginPassword'].forEach(id => {
  const el = $(id);
  if (!el) return;
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      $('btnLogin').click();
    }
  });
});

  $('btnLogout').addEventListener('click',()=>{CUR=null; location.reload()});

  // tabs
  document.querySelectorAll('#tabs .tab').forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));

  // shortcuts
  window.addEventListener('keydown',e=>{if(e.key==='/'&&!e.metaKey&&!e.ctrlKey){e.preventDefault(); $('searchPosts').focus()} if(e.key.toLowerCase()==='l'){ $('loginUsername').focus()} if(e.key.toLowerCase()==='n'){ $('postTitle').focus()}});

  // search filter
  $('searchPosts').addEventListener('input',()=>renderPosts());

  // FX
  $('btnRate').addEventListener('click',async()=>{const b=$('fxBase').value.trim().toUpperCase(); const t=$('fxTarget').value.trim().toUpperCase(); try{const r=await getRate(b,t); $('fxResult').textContent=I18N[LANG].rate_result(b,r,t)}catch{ $('fxResult').textContent='Error' }});

  // Stocks
  $('btnDraw').addEventListener('click',async()=>{const t=$('stockTicker').value.trim(); const msg=$('stockMsg'); msg.textContent='Fetching...'; try{const pts=await yahooDaily(t); if(!pts.length) throw 0; draw(pts); msg.textContent=''}catch{ msg.textContent='Fetch/Chart error. Try another ticker.' }});

  // Community
  let currentId=null, saveTimer=null;
  function renderPosts(){const list=$('postList'); const q=$('searchPosts').value.toLowerCase(); const P=listPosts().filter(p=>(p.title+p.content).toLowerCase().includes(q)); list.innerHTML=P.map(p=>`<li class='p-3 border rounded-xl flex items-center justify-between gap-2'><div><div class='font-semibold'>${p.title}</div><div class='text-xs text-slate-500'>@${p.user} â€¢ ${new Date(p.created_at).toLocaleString()}</div></div><div class='flex gap-2'><button class='btn-alt' data-act='edit' data-id='${p.id}' data-owner='${p.user}'>Edit</button><button class='btn-alt' data-act='del' data-id='${p.id}' data-owner='${p.user}'>Delete</button></div></li>`).join(''); $('postCount').textContent=`${P.length} posts`; list.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{const id=+btn.dataset.id, owner=btn.dataset.owner; if(btn.dataset.act==='edit'){const post=listPosts().find(x=>x.id===id); currentId=id; $('postTitle').value=post.title; $('postContent').value=post.content; renderComments()} else { if(owner!==CUR.username&&!CUR.is_admin) return alert(I18N[LANG].not_owner); deletePost(id); currentId=null; $('postTitle').value=''; $('postContent').value=''; $('commentList').innerHTML=''; renderPosts() }}))}
  function renderComments(){const ul=$('commentList'); const items=listComments(currentId); ul.innerHTML=items.map(c=>`<li class='p-2 border rounded-xl flex items-center justify-between'><div><b>@${c.user}</b> ${c.content}</div><button class='btn-alt text-xs' data-id='${c.id}' data-owner='${c.user}'>Delete</button></li>`).join(''); ul.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{const cid=+b.dataset.id; const owner=b.dataset.owner; if(owner!==CUR.username&&!CUR.is_admin) return alert(I18N[LANG].not_owner); deleteComment(cid); renderComments()}))}
  $('btnNewPost').addEventListener('click',()=>{currentId=null; $('postTitle').value=''; $('postContent').value=''; $('commentList').innerHTML=''});
  $('btnSavePost').addEventListener('click',()=>{const title=$('postTitle').value.trim(); const content=$('postContent').value.trim(); if(!title) return alert(I18N[LANG].need_title); if(!content) return alert(I18N[LANG].need_content); if(hasBad(title)||hasBad(content)) return alert('ë¹„ì†ì–´ê°€ í¬í•¨ë˜ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); const post=currentId?listPosts().find(p=>p.id===currentId):{user:CUR.username,created_at:new Date().toISOString()}; if(currentId && post.user!==CUR.username && !CUR.is_admin) return alert(I18N[LANG].not_owner); post.title=title; post.content=content; savePost(post); LS.set(KEY.draft,null); $('autoSaveMsg').textContent=''; renderPosts()});
  $('btnDeletePost').addEventListener('click',()=>{if(!currentId) return; const post=listPosts().find(p=>p.id===currentId); if(post.user!==CUR.username&&!CUR.is_admin) return alert(I18N[LANG].not_owner); deletePost(currentId); currentId=null; $('postTitle').value=''; $('postContent').value=''; $('commentList').innerHTML=''; renderPosts()});
  $('btnAddComment').addEventListener('click',()=>{if(!currentId) return; const c=$('commentInput').value.trim(); if(!c) return; if(hasBad(c)) return alert('ë¹„ì†ì–´ê°€ í¬í•¨ë˜ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); addComment(currentId,c); $('commentInput').value=''; renderComments()});
  const draft=LS.get(KEY.draft,null); if(draft){$('postTitle').value=draft.title||''; $('postContent').value=draft.content||''; $('autoSaveMsg').textContent='(draft restored)'}
  $('postTitle').addEventListener('input',autoSave); $('postContent').addEventListener('input',autoSave);
  function autoSave(){clearTimeout(saveTimer); saveTimer=setTimeout(()=>{LS.set(KEY.draft,{title:$('postTitle').value,content:$('postContent').value}); $('autoSaveMsg').textContent='draft saved'; setTimeout(()=>$('autoSaveMsg').textContent='',1200)}, 600)}

  // Admin
  function renderAdmin(){ if(!CUR?.is_admin) return; const U=LS.get(KEY.users,[]); const L=LS.get(KEY.logs,[]); const uBox=$('userTable'); uBox.innerHTML=''; uBox.appendChild(table(['id','username','name','email','admin','created'],U.map(u=>[u.id,u.username,u.full_name||'',u.email||'',String(!!u.is_admin),new Date(u.created_at).toLocaleString()]))); const lBox=$('logTable'); lBox.innerHTML=''; lBox.appendChild(table(['id','user','action','at','meta'],L.map(g=>[g.id,g.user||'',g.action,new Date(g.at).toLocaleString(),JSON.stringify(g.meta)]))) }

  // Export / Import
  $('btnExport').addEventListener('click',()=>{const dump={users:LS.get(KEY.users,[]),posts:LS.get(KEY.posts,[]),comments:LS.get(KEY.comments,[]),logs:LS.get(KEY.logs,[])}; const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='korual_export.json'; a.click(); URL.revokeObjectURL(a.href)});
  $('fileImport').addEventListener('change',async e=>{const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{const obj=JSON.parse(txt); if(obj.users) LS.set(KEY.users,obj.users); if(obj.posts) LS.set(KEY.posts,obj.posts); if(obj.comments) LS.set(KEY.comments,obj.comments); if(obj.logs) LS.set(KEY.logs,obj.logs); alert('Imported.'); if(CUR?.is_admin) renderAdmin(); renderPosts()}catch{alert('Invalid JSON')} e.target.value=''});
})();
</script>
</body>
</html>


