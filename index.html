<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />

  <!-- 이미 로그인된 경우 대시보드로 이동 -->
  <script>
    (function () {
      try {
        const raw = localStorage.getItem("korual_user");
        if (!raw) return;
        const user = JSON.parse(raw);
        if (user && user.username) location.replace("dashboard.html");
      } catch (_) {}
    })();
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>KORUAL Control Center – Login</title>

  <!-- Tailwind (개발용 CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: dark; }

    body{
      min-height:100vh;
      margin:0;
      color:#e5e7eb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 15% 18%, rgba(34,211,238,0.16), transparent 60%),
        radial-gradient(820px 560px at 82% 65%, rgba(99,102,241,0.16), transparent 60%),
        radial-gradient(520px 320px at 60% 22%, rgba(56,189,248,0.10), transparent 62%),
        linear-gradient(180deg, #020617, #030B1E 55%, #020617);
      overflow-x:hidden;
    }

    /* Subtle animated radar + rings (high-end feel) */
    .rings{
      position:fixed;
      inset:0;
      margin:auto;
      width:min(840px, 110vw);
      height:min(840px, 110vw);
      border-radius:9999px;
      pointer-events:none;
      z-index:-1;
      opacity:.28;
      filter: blur(.2px);
      background:
        radial-gradient(circle at center, rgba(148,163,184,0.12), transparent 35%),
        radial-gradient(circle at center, rgba(148,163,184,0.10), transparent 52%),
        radial-gradient(circle at center, rgba(148,163,184,0.08), transparent 68%),
        radial-gradient(circle at center, rgba(148,163,184,0.06), transparent 82%);
    }
    .sweep{
      position:absolute;
      inset:0;
      border-radius:9999px;
      background: conic-gradient(from 180deg,
        rgba(34,211,238,.42),
        rgba(34,211,238,.12) 10%,
        transparent 34%,
        transparent
      );
      animation: sweep 16s linear infinite;
      filter: blur(8px);
      mix-blend-mode: screen;
      opacity:.78;
    }
    @keyframes sweep { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* Glass card */
    .glass{
      background: rgba(3, 8, 23, 0.62);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow:
        0 40px 120px rgba(0,0,0,0.65),
        inset 0 1px 0 rgba(255,255,255,0.06);
    }

    /* Inputs */
    .input{
      width:100%;
      padding:.9rem 1.05rem;
      border-radius: 1rem;
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.28);
      color:#e5e7eb;
      font-size:.95rem;
      outline:none;
      transition: .2s ease;
    }
    .input:focus{
      border-color: rgba(34,211,238,0.70);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.16);
    }

    /* Button */
    .btn{
      width:100%;
      padding:.95rem 1.05rem;
      border-radius: 1rem;
      font-weight: 700;
      letter-spacing: .02em;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      box-shadow:
        0 24px 70px rgba(2,6,23,0.95),
        0 0 0 1px rgba(148,163,184,0.12);
      transition: transform .12s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0px); filter: brightness(.98); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Toast */
    #toastRoot{
      position:fixed;
      inset-inline:0;
      bottom: 22px;
      z-index:50;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      max-width: 560px;
      width: min(92vw, 560px);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.68);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 26px 90px rgba(0,0,0,0.6);
      padding: 14px 16px;
    }
    .dot{ width:10px; height:10px; border-radius:9999px; margin-top:3px; }

    /* Tiny sheen line on top of card */
    .sheen{
      position:absolute;
      left:16px;
      right:16px;
      top:14px;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      opacity:.7;
      pointer-events:none;
    }

    /* Micro text */
    .muted{ color: rgba(226,232,240,0.65); }
    .soft{ border:1px solid rgba(148,163,184,0.18); background: rgba(2,6,23,0.45); }

    /* Remove default focus outline for buttons (we handle visually) */
    button:focus{ outline:none; }
  </style>
</head>

<body>
  <div class="rings">
    <div class="sweep"></div>
  </div>

  <div id="toastRoot"></div>

  <main class="max-w-6xl mx-auto px-6 pt-14 pb-16">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-white text-slate-900 grid place-content-center font-extrabold text-xl shadow-lg">K</div>
        <div class="text-left">
          <div class="text-[11px] uppercase tracking-[0.32em] text-slate-400">Korual Control Center</div>
          <div class="text-2xl font-semibold leading-tight">하이엔드 운영 로그인</div>
        </div>
      </div>
      <p class="mt-3 text-sm muted">승인된 계정만 접근할 수 있습니다. 접속 이력은 자동 기록됩니다.</p>
    </header>

    <!-- Card -->
    <section class="relative glass rounded-[28px] max-w-xl mx-auto px-6 sm:px-8 py-7 sm:py-8">
      <div class="sheen"></div>

      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-xl font-semibold">KORUAL 로그인</h1>
          <p class="text-sm muted mt-1">계정 인증 후 Control Center로 이동합니다.</p>
        </div>
        <div class="hidden sm:flex items-center gap-2 soft rounded-2xl px-3 py-2">
          <div class="w-2.5 h-2.5 rounded-full bg-emerald-400/80"></div>
          <div class="text-xs text-slate-200/80">Secure Session</div>
        </div>
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-sm text-slate-200/90 mb-1.5 block">아이디</label>
          <div class="relative">
            <span class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-500">@</span>
            <input id="loginUsername" class="input pl-9" placeholder="예: KORUAL" autocomplete="username" />
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-200/90 mb-1.5 block">비밀번호</label>
          <input id="loginPassword" type="password" class="input" placeholder="••••••••" autocomplete="current-password" />
        </div>

        <button id="btnLogin" class="btn mt-1">로그인</button>

        <p id="loginMsg" class="text-sm text-rose-300 h-5 mt-1"></p>

        <!-- Test account row -->
        <div class="pt-3">
          <div class="text-xs muted mb-2">테스트용 기본 계정</div>
          <div class="flex flex-wrap items-center gap-2 soft rounded-2xl px-3 py-2.5">
            <span class="text-xs muted">ID</span>
            <code class="text-xs bg-slate-800/70 px-2 py-1 rounded-lg border border-slate-700/60">KORUAL</code>
            <span class="text-xs muted">PW</span>
            <code class="text-xs bg-slate-800/70 px-2 py-1 rounded-lg border border-slate-700/60">GUEST</code>
            <button id="btnFillDemo" class="text-xs text-cyan-300 underline decoration-dotted underline-offset-4 ml-auto" type="button">
              자동 입력
            </button>
          </div>
        </div>

        <!-- Mini footer -->
        <div class="pt-2 flex items-center justify-between text-xs muted">
          <span id="apiHint" class="truncate">API: /api/korual/login</span>
          <button id="btnPing" type="button" class="text-xs text-slate-200/80 hover:text-cyan-300 transition underline decoration-dotted underline-offset-4">
            연결 테스트
          </button>
        </div>
      </div>
    </section>

    <footer class="text-center mt-10 text-xs muted">
      © KORUAL. Unauthorized access is prohibited.
    </footer>
  </main>

  <script>
    /************************************************************
     * High-end Login (index.html)
     * - CORS 해결: Vercel same-origin 프록시 사용
     *   POST /api/korual/login
     *   GET  /api/korual/whoami?token=...
     ************************************************************/

    const TOKEN_KEY = "korual_token";
    const USER_KEY  = "korual_user";

    const elU = document.getElementById("loginUsername");
    const elP = document.getElementById("loginPassword");
    const elBtn = document.getElementById("btnLogin");
    const elMsg = document.getElementById("loginMsg");
    const elDemo = document.getElementById("btnFillDemo");
    const elPing = document.getElementById("btnPing");
    const elApiHint = document.getElementById("apiHint");
    const toastRoot = document.getElementById("toastRoot");

    // 프록시 엔드포인트(동일 오리진)
    const LOGIN_ENDPOINT = "/api/korual/login";
    const WHOAMI_ENDPOINT = "/api/korual/whoami";
    const PING_ENDPOINT = "/api/korual/ping"; // 선택(없으면 GAS ping 프록시를 추가하세요)

    elApiHint.textContent = "API: " + LOGIN_ENDPOINT;

    function setMsg(text){ elMsg.textContent = text || ""; }

    function setLoading(loading){
      elBtn.disabled = !!loading;
      elBtn.textContent = loading ? "로그인 중..." : "로그인";
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function toast(text, kind){
      const wrap = document.createElement("div");
      wrap.className = "toast";
      const dot =
        kind === "ok" ? "bg-emerald-400" :
        kind === "warn" ? "bg-amber-400" :
        kind === "err" ? "bg-rose-400" : "bg-cyan-400";

      wrap.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="dot ${dot}"></div>
          <div class="text-sm text-slate-100 whitespace-pre-line">${escapeHtml(text)}</div>
        </div>
      `;
      toastRoot.appendChild(wrap);

      setTimeout(() => {
        wrap.style.opacity = "0";
        wrap.style.transform = "translateY(6px)";
        wrap.style.transition = "all .35s ease";
      }, 2400);
      setTimeout(() => wrap.remove(), 2850);
    }

    async function postJson(url, body){
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    async function getJson(url){
      const res = await fetch(url, { method: "GET" });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    function saveSession(data){
      if (data && data.token) localStorage.setItem(TOKEN_KEY, data.token);
      if (data && data.user)  localStorage.setItem(USER_KEY, JSON.stringify(data.user));
    }

    function normalizeError(data){
      const err = (data && data.error) ? String(data.error) : "LOGIN_FAILED";
      let extra = "";
      if (err === "ACCOUNT_LOCKED" && data.lockedUntil) extra = `\n잠금 해제: ${data.lockedUntil}`;
      if (err === "INVALID_PASSWORD" && typeof data.failCount === "number") extra = `\n실패 횟수: ${data.failCount}`;
      return { err, extra };
    }

    async function handleLogin(){
      setMsg("");
      const username = String(elU.value || "").trim();
      const password = String(elP.value || "");

      if (!username || !password){
        setMsg("아이디/비밀번호를 입력하세요.");
        toast("아이디/비밀번호를 입력하세요.", "warn");
        return;
      }

      setLoading(true);
      try{
        const { data } = await postJson(LOGIN_ENDPOINT, { username, password });

        if (!data || !data.ok){
          const { err, extra } = normalizeError(data || {});
          setMsg("로그인 실패: " + err);
          toast("로그인 실패: " + err + extra, "err");
          return;
        }

        saveSession(data);
        const display = (data.user && (data.user.displayName || data.user.username)) || username;

        toast(`로그인 성공\nWelcome, ${display}`, "ok");
        location.replace("dashboard.html");
      } catch (e){
        setMsg("서버 통신 실패");
        toast("서버 통신 실패\n" + String(e), "err");
      } finally{
        setLoading(false);
      }
    }

    // Enter 키 로그인
    [elU, elP].forEach(el => {
      el.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          handleLogin();
        }
      });
    });

    elBtn.addEventListener("click", handleLogin);

    // 데모 자동 입력
    elDemo.addEventListener("click", () => {
      elU.value = "KORUAL";
      elP.value = "GUEST";
      setMsg("");
      toast("데모 계정 자동 입력 완료", "warn");
      elP.focus();
    });

    // 연결 테스트 (ping 프록시가 없으면 whoami로 대체)
    elPing.addEventListener("click", async () => {
      setMsg("");
      try{
        // ping 프록시가 준비되어 있으면 사용
        const r = await fetch(PING_ENDPOINT, { method: "GET" });
        if (r.ok){
          const data = await r.json().catch(() => ({}));
          if (data && data.ok) return toast("연결 정상 (PING OK)", "ok");
        }
        // 대체: whoami (토큰 있으면)
        const token = localStorage.getItem(TOKEN_KEY) || "";
        if (!token) return toast("연결 테스트 OK\n(토큰 없음: whoami 생략)", "ok");

        const { data } = await getJson(`${WHOAMI_ENDPOINT}?token=${encodeURIComponent(token)}`);
        if (data && data.ok) toast("연결 정상 (WHOAMI OK)", "ok");
        else toast("연결은 되지만 세션이 유효하지 않습니다.", "warn");
      } catch (e){
        toast("연결 실패\n" + String(e), "err");
      }
    });
  </script>
</body>
</html>
